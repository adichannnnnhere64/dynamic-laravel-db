import{r as m,u as ae,j as e,H as te}from"./app-DGXHZrET.js";import{A as le,D as A,X as b,t as N}from"./app-layout-Dql5IVxS.js";import{C as V,a as ie,b as re,d as ne,c as I,e as ce}from"./card-Cv8tL66e.js";import{S as u,a as p,b as j,c as _,d as n}from"./select-WM5803v_.js";import{L as r}from"./label-DBVC41B8.js";import{I as o}from"./input-Swp7yrj4.js";import{T as de}from"./textarea-B_sZqpDt.js";import{B as h}from"./app-logo-icon-7BszVvf1.js";import{B as oe}from"./badge-CoxKmixK.js";import{S as y}from"./separator-ppLL2Yib.js";import{T as me,a as he,b as D,c as q,S as O}from"./switch-D8sGGSWS.js";import{C as xe}from"./chevron-left-DYaWPLKH.js";import{B as w}from"./bell-COGtJX83.js";import{G as ue}from"./grid-3x3-DEFDCKDH.js";import{M as pe}from"./mail-DMr3mBLC.js";import{M as je}from"./message-square-COnAHpUs.js";import{P as B}from"./plus-ETX__35k.js";import{C as _e}from"./circle-alert-BCNKFD3J.js";import{S as ve}from"./save-CFDqwi_A.js";/* empty css            */import"./index-Bvj2GysQ.js";import"./index-Bb28m5l8.js";import"./index-B3m84JAj.js";import"./loader-circle-Cxhx236L.js";import"./index-Cqw0yIc8.js";import"./check-BfHHevVA.js";function We({connections:C,selectedConnection:M,selectedTable:S,fields:Y}){const[x,L]=m.useState(M?.id?.toString()||""),[d,k]=m.useState(S?.id?.toString()||""),[T,z]=m.useState([]),[H,E]=m.useState(Y||[]),[F,P]=m.useState("email"),{data:a,setData:l,post:G,processing:f,errors:t}=ae({connection_table_id:d?parseInt(d):"",name:"",field_to_watch:"",condition_type:"less_than",threshold_value:"",string_value:"",is_active:!0,notification_emails:[""],telegram_chat_ids:[""],telegram_bot_token:"",notification_subject:"Database Alert: {observer_name}",notification_message:'The condition "{condition}" has been met for field "{field}" in table "{table_name}". Current value: {current_value}',check_interval_minutes:60});m.useEffect(()=>{if(x){const s=C.find(i=>i.id.toString()===x);z(s?.tables||[]),k(""),l("connection_table_id",""),E([])}},[x]),m.useEffect(()=>{if(d){const s=T.find(i=>i.id.toString()===d);E(s?.fields||[]),l("connection_table_id",parseInt(d)),s?.fields?.length>0&&!a.field_to_watch&&l("field_to_watch",s.fields[0])}},[d]);const W=s=>{s.preventDefault();const i=a.notification_emails.filter(g=>g&&g.trim()!==""),c=a.telegram_chat_ids.filter(g=>g&&g.trim()!==""),v=i.length>0,se=c.length>0&&a.telegram_bot_token.trim()!=="";if(!v&&!se){N.error("Configuration Error",{description:"Please provide at least one notification method (email or Telegram)"});return}G("/value-observers",{preserveScroll:!0,onSuccess:()=>{N.success("Value Observer Created",{description:"Your observer has been created successfully"})},onError:()=>{N.error("Creation Failed",{description:"Please check the form for errors"})}})},R=()=>{l("notification_emails",[...a.notification_emails,""])},U=s=>{if(a.notification_emails.length>1){const i=a.notification_emails.filter((c,v)=>v!==s);l("notification_emails",i)}},X=(s,i)=>{const c=[...a.notification_emails];c[s]=i,l("notification_emails",c)},J=()=>{l("telegram_chat_ids",[...a.telegram_chat_ids,""])},K=s=>{if(a.telegram_chat_ids.length>1){const i=a.telegram_chat_ids.filter((c,v)=>v!==s);l("telegram_chat_ids",i)}},Q=(s,i)=>{const c=[...a.telegram_chat_ids];c[s]=i,l("telegram_chat_ids",c)},Z=[{value:"less_than",label:"Less than",description:"Value is less than threshold"},{value:"greater_than",label:"Greater than",description:"Value is greater than threshold"},{value:"equals",label:"Equals",description:"Value equals threshold"},{value:"not_equals",label:"Not equals",description:"Value does not equal threshold"},{value:"contains",label:"Contains",description:"Value contains text"},{value:"starts_with",label:"Starts with",description:"Value starts with text"},{value:"ends_with",label:"Ends with",description:"Value ends with text"},{value:"date_near_expiry",label:"Near expiration date",description:"Alert when date is nearing expiry"},{value:"date_expired",label:"Expired",description:"Alert when date is expired"},{value:"date_future",label:"Future date",description:"Alert when date is in future"},{value:"date_past",label:"Past date",description:"Alert when date is in past"}],$=[{value:"date",label:"Date (YYYY-MM-DD)"},{value:"datetime",label:"Date & Time"},{value:"timestamp",label:"Timestamp"}],ee=()=>{switch(a.condition_type){case"less_than":case"greater_than":return e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"threshold_value",children:"Threshold Value"}),e.jsx(o,{id:"threshold_value",type:"number",step:"any",value:a.threshold_value||"",onChange:s=>l("threshold_value",s.target.value||null),placeholder:"Enter threshold value"}),t.threshold_value&&e.jsx("p",{className:"text-sm text-red-600",children:t.threshold_value})]});case"equals":case"not_equals":case"contains":case"starts_with":case"ends_with":return e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"string_value",children:"Text Value"}),e.jsx(o,{id:"string_value",value:a.string_value||"",onChange:s=>l("string_value",s.target.value||null),placeholder:"Enter text to compare"}),t.string_value&&e.jsx("p",{className:"text-sm text-red-600",children:t.string_value})]});case"date_near_expiry":case"date_expired":case"date_future":case"date_past":return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"date_field_type",children:"Date Field Type"}),e.jsxs(u,{value:a.date_field_type||"",onValueChange:s=>l("date_field_type",s),children:[e.jsx(p,{children:e.jsx(j,{placeholder:"Select date type"})}),e.jsx(_,{children:$.map(s=>e.jsx(n,{value:s.value,children:s.label},s.value))})]}),t.date_field_type&&e.jsx("p",{className:"text-sm text-red-600",children:t.date_field_type})]}),a.condition_type==="date_near_expiry"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"days_before_alert",children:"Alert Before Days"}),e.jsx(o,{id:"days_before_alert",type:"number",min:"1",max:"365",value:a.days_before_alert||"",onChange:s=>l("days_before_alert",s.target.value),placeholder:"e.g., 7 (alert 7 days before expiry)"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Send alert when date is within this many days"}),t.days_before_alert&&e.jsx("p",{className:"text-sm text-red-600",children:t.days_before_alert})]}),a.condition_type==="date_expired"&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(O,{checked:a.alert_on_expired||!1,onCheckedChange:s=>l("alert_on_expired",s)}),e.jsx(r,{htmlFor:"alert_on_expired",children:"Alert on expired dates"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"date_format",children:"Date Format (Optional)"}),e.jsx(o,{id:"date_format",value:a.date_format||"",onChange:s=>l("date_format",s.target.value),placeholder:"e.g., Y-m-d, Y-m-d H:i:s"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Leave empty for auto-detection. Common formats: Y-m-d, Y-m-d H:i:s, d/m/Y"}),t.date_format&&e.jsx("p",{className:"text-sm text-red-600",children:t.date_format})]})]});default:return null}};return e.jsxs(le,{children:[e.jsx(te,{title:"Create Value Observer"}),e.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-black",children:[e.jsx("div",{className:"border-b bg-white dark:bg-black",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(h,{variant:"ghost",size:"sm",onClick:()=>window.history.back(),className:"gap-2",children:[e.jsx(xe,{className:"w-4 h-4"}),"Back"]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(w,{className:"w-6 h-6 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Create Value Observer"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Monitor database values and get alerts"})]})]})]})})})}),e.jsx("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs(V,{children:[e.jsxs(ie,{children:[e.jsx(re,{children:"Observer Configuration"}),e.jsx(ne,{children:"Configure what to monitor and when to alert"})]}),e.jsx(I,{children:e.jsxs("form",{onSubmit:W,className:"space-y-8",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(A,{className:"w-5 h-5"}),"Step 1: Select Database & Table"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"connection",children:"Database Connection"}),e.jsxs(u,{value:x,onValueChange:L,children:[e.jsx(p,{children:e.jsx(j,{placeholder:"Select a connection"})}),e.jsx(_,{children:C.filter(s=>s&&s.id&&s.name).map(s=>e.jsx(n,{value:s.id.toString(),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4"}),s.name]})},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"table",children:"Table"}),e.jsxs(u,{value:d,onValueChange:k,disabled:!x,children:[e.jsx(p,{children:e.jsx(j,{placeholder:x?"Select a table":"Select connection first"})}),e.jsx(_,{children:T.filter(s=>s&&s.id&&s.name).map(s=>e.jsx(n,{value:s.id.toString(),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4"}),s.name,e.jsx(oe,{variant:"outline",className:"ml-2 text-xs",children:s.table_name})]})},s.id))})]})]})]}),t.connection_table_id&&e.jsx("p",{className:"text-sm text-red-600",children:t.connection_table_id})]}),e.jsx(y,{}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(w,{className:"w-5 h-5"}),"Step 2: Configure What to Watch"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"name",children:"Observer Name"}),e.jsx(o,{id:"name",value:a.name,onChange:s=>l("name",s.target.value),placeholder:"e.g., Low Stock Alert",required:!0}),t.name&&e.jsx("p",{className:"text-sm text-red-600",children:t.name})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"field_to_watch",children:"Field to Watch"}),e.jsxs(u,{value:a.field_to_watch,onValueChange:s=>l("field_to_watch",s),disabled:!d,children:[e.jsx(p,{children:e.jsx(j,{placeholder:d?"Select a field":"Select table first"})}),e.jsx(_,{children:H.filter(s=>s&&s.trim()!=="").map(s=>e.jsx(n,{value:s,children:s},s))})]}),t.field_to_watch&&e.jsx("p",{className:"text-sm text-red-600",children:t.field_to_watch})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"condition_type",children:"Condition Type"}),e.jsxs(u,{value:a.condition_type,onValueChange:s=>l("condition_type",s),children:[e.jsx(p,{children:e.jsx(j,{})}),e.jsx(_,{children:Z.map(s=>e.jsx(n,{value:s.value,children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.label}),e.jsx("div",{className:"text-xs text-gray-500",children:s.description})]})},s.value))})]}),t.condition_type&&e.jsx("p",{className:"text-sm text-red-600",children:t.condition_type})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{children:"Condition Value"}),ee()]})]})]}),e.jsx(y,{}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[e.jsx(w,{className:"w-5 h-5"}),"Step 3: Notification Settings"]}),e.jsxs(me,{value:F,onValueChange:P,children:[e.jsxs(he,{className:"grid grid-cols-2 mb-6",children:[e.jsxs(D,{value:"email",className:"gap-2",children:[e.jsx(pe,{className:"w-4 h-4"}),"Email Notifications"]}),e.jsxs(D,{value:"telegram",className:"gap-2",children:[e.jsx(je,{className:"w-4 h-4"}),"Telegram Notifications"]})]}),e.jsxs(q,{value:"email",className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(r,{children:"Email Recipients"}),e.jsx("div",{className:"space-y-3 mt-2",children:a.notification_emails.map((s,i)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{type:"email",value:s,onChange:c=>X(i,c.target.value),placeholder:"email@example.com",required:i===0}),a.notification_emails.length>1&&e.jsx(h,{type:"button",variant:"outline",size:"icon",onClick:()=>U(i),children:e.jsx(b,{className:"w-4 h-4"})})]},i))}),e.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:R,className:"mt-2",children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"Add Another Email"]}),t.notification_emails&&e.jsx("p",{className:"text-sm text-red-600",children:t.notification_emails})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"notification_subject",children:"Email Subject"}),e.jsx(o,{id:"notification_subject",value:a.notification_subject,onChange:s=>l("notification_subject",s.target.value),placeholder:"Alert: {observer_name}",required:!0}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Available variables: ","{observer_name}",", ","{table_name}",", ","{field}",", ","{condition}"]}),t.notification_subject&&e.jsx("p",{className:"text-sm text-red-600",children:t.notification_subject})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"notification_message",children:"Email Message"}),e.jsx(de,{id:"notification_message",value:a.notification_message,onChange:s=>l("notification_message",s.target.value),rows:4,required:!0}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Available variables: ","{observer_name}",", ","{table_name}",", ","{field}",", ","{condition}",", ","{current_value}",", ","{record_id}"]}),t.notification_message&&e.jsx("p",{className:"text-sm text-red-600",children:t.notification_message})]})]}),e.jsxs(q,{value:"telegram",className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(r,{htmlFor:"telegram_bot_token",children:"Telegram Bot Token"}),e.jsx(o,{id:"telegram_bot_token",type:"password",value:a.telegram_bot_token,onChange:s=>l("telegram_bot_token",s.target.value),placeholder:"1234567890:ABCdefGHIjklMNOpqrsTUVwxyz"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Get your bot token from @BotFather on Telegram"}),t.telegram_bot_token&&e.jsx("p",{className:"text-sm text-red-600",children:t.telegram_bot_token})]}),e.jsxs("div",{children:[e.jsx(r,{children:"Telegram Chat IDs"}),e.jsx("div",{className:"space-y-3 mt-2",children:a.telegram_chat_ids.map((s,i)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{value:s,onChange:c=>Q(i,c.target.value),placeholder:"123456789",required:i===0&&F==="telegram"}),a.telegram_chat_ids.length>1&&e.jsx(h,{type:"button",variant:"outline",size:"icon",onClick:()=>K(i),children:e.jsx(b,{className:"w-4 h-4"})})]},i))}),e.jsxs(h,{type:"button",variant:"outline",size:"sm",onClick:J,className:"mt-2",children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"Add Another Chat ID"]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Users need to start a chat with your bot first, then share their chat ID"}),t.telegram_chat_ids&&e.jsx("p",{className:"text-sm text-red-600",children:t.telegram_chat_ids})]}),e.jsx(V,{className:"dark:bg-black ",children:e.jsxs(I,{className:"pt-6",children:[e.jsx("h4",{className:"font-semibold dark:text-white mb-2",children:"Telegram Message Preview"}),e.jsx("p",{className:"text-sm dark:text-white mb-2",children:"Alerts will be sent in this format:"}),e.jsxs("div",{className:"text-sm dark:bg-black bg-white p-3 rounded border",children:[e.jsxs("p",{children:["âš ï¸ ",e.jsx("strong",{children:"Database Value Alert"})]}),e.jsxs("p",{children:["ðŸ” ",e.jsx("strong",{children:"Observer:"})," ",a.name||"Observer Name"]}),e.jsxs("p",{children:["ðŸ“Š ",e.jsx("strong",{children:"Table:"})," ",S?.name||"Table Name"]}),e.jsxs("p",{children:["ðŸŽ¯ ",e.jsx("strong",{children:"Field:"})," ",a.field_to_watch||"field_name"]}),e.jsxs("p",{children:["ðŸ“ ",e.jsx("strong",{children:"Condition:"})," ",a.condition_type?.replace("_"," ")," ",a.threshold_value||a.string_value]}),e.jsxs("p",{children:["ðŸ“ˆ ",e.jsx("strong",{children:"Current Value:"})," [value]"]})]})]})})]})]}),e.jsxs("div",{className:"rounded-lg bg-yellow-50 border border-yellow-200 p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-yellow-800",children:[e.jsx(_e,{className:"w-5 h-5"}),e.jsx("p",{className:"text-sm font-medium",children:"Notification Method"})]}),e.jsx("p",{className:"text-sm text-yellow-700 mt-1",children:"You can configure both email and Telegram notifications, or just one. At least one notification method is required."})]})]}),e.jsx(y,{}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Step 4: Schedule & Activation"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"check_interval_minutes",children:"Check Interval (minutes)"}),e.jsxs(u,{value:a.check_interval_minutes.toString(),onValueChange:s=>l("check_interval_minutes",parseInt(s)),children:[e.jsx(p,{children:e.jsx(j,{})}),e.jsxs(_,{children:[e.jsx(n,{value:"1",children:"Every minute"}),e.jsx(n,{value:"2",children:"Every 2 minutes"}),e.jsx(n,{value:"3",children:"Every 3 minutes"}),e.jsx(n,{value:"5",children:"Every 5 minutes"}),e.jsx(n,{value:"15",children:"Every 15 minutes"}),e.jsx(n,{value:"30",children:"Every 30 minutes"}),e.jsx(n,{value:"60",children:"Every hour"}),e.jsx(n,{value:"180",children:"Every 3 hours"}),e.jsx(n,{value:"360",children:"Every 6 hours"}),e.jsx(n,{value:"720",children:"Every 12 hours"}),e.jsx(n,{value:"1440",children:"Every day"})]})]}),t.check_interval_minutes&&e.jsx("p",{className:"text-sm text-red-600",children:t.check_interval_minutes})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(r,{htmlFor:"is_active",children:"Observer Status"}),e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Active"}),e.jsx("div",{className:"text-sm text-gray-500",children:a.is_active?"Observer is active and will check":"Observer is paused"})]}),e.jsx(O,{checked:a.is_active,onCheckedChange:s=>l("is_active",s)})]}),t.is_active&&e.jsx("p",{className:"text-sm text-red-600",children:t.is_active})]})]})]}),e.jsx(ce,{className:"px-0 pb-0 pt-6",children:e.jsxs("div",{className:"flex justify-between w-full",children:[e.jsxs(h,{type:"button",variant:"outline",onClick:()=>window.history.back(),disabled:f,children:[e.jsx(b,{className:"w-4 h-4 mr-2"}),"Cancel"]}),e.jsx(h,{type:"submit",disabled:f,className:"gap-2",children:f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"w-4 h-4"}),"Create Observer"]})})]})})]})})]})})]})]})}export{We as default};
